<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MP4 Library Player (Drive webContentLink fix)</title>
  <style>
    /* ... (keep your existing CSS from previous script exactly) ... */
    /* For brevity, use your previous CSS */
  </style>
</head>
<body>
  <div class="app">
    <header>
      <span class="brand"><span class="dot"></span> MP4 Library Player</span>
      <span class="pill" id="fileCount">Loading…</span>
      <span class="pill" id="folderStatus">Folder: connecting…</span>
    </header>

    <div class="main">
      <aside class="sidebar">
        <div class="title">Library</div>
        <div class="card">
          <div class="stat"><span>Source</span><span id="sourceType">Google Drive</span></div>
          <div class="stat"><span>Items</span><span id="statItems">–</span></div>
          <div class="stat"><span>Loaded</span><span id="statLoaded">0</span></div>
        </div>
        <div class="title">Tips</div>
        <div class="card" style="color:var(--muted);font-size:13px">
          Make sure your Drive files are shared as <b>Anyone with the link → Viewer</b>. If items don't play, check sharing.
        </div>
      </aside>

      <section class="content">
        <div class="toolbar">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input id="search" placeholder="Search videos by name…" />
          </div>
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>

        <div id="list" class="list">
          <div class="empty">Fetching your files…</div>
        </div>
      </section>
    </div>

    <footer class="now">
      <!-- Now Playing bar (same as before) -->
      <div class="np-left">
        <div class="cover" id="npCover"></div>
        <div>
          <div class="title" id="npTitle">Nothing playing</div>
          <div class="subtitle" id="npSubtitle">Select a track to start</div>
        </div>
      </div>
      <div class="controls">
        <button class="icon-btn" id="prevBtn" title="Previous">⏮</button>
        <button class="icon-btn" id="playPauseBtn" title="Play/Pause">▶</button>
        <button class="icon-btn" id="nextBtn" title="Next">⏭</button>
      </div>
      <div class="progress">
        <span id="curTime" class="subtitle" style="width:42px;text-align:right">0:00</span>
        <input id="seek" class="range" type="range" min="0" max="1" step="0.001" value="0" />
        <span id="dur" class="subtitle" style="width:42px">0:00</span>
        <div class="vol">
          <span class="subtitle label">Vol</span>
          <input id="vol" class="range" type="range" min="0" max="1" step="0.01" value="1" style="width:120px" />
        </div>
      </div>
    </footer>
  </div>

<script>
  const API_KEY = "AIzaSyB0nTrRieFp3iKYKo15B2gqJEE3SlFAo0A";
  const FOLDER_ID = "1TQcruPfeldisldQxIjNTXd6WSmX8jn8i";

  const listEl = document.getElementById("list");
  const fileCount = document.getElementById("fileCount");
  const folderStatus = document.getElementById("folderStatus");
  const statItems = document.getElementById("statItems");
  const statLoaded = document.getElementById("statLoaded");

  let allFiles = [];
  let filtered = [];
  let currentIndex = -1;

  const media = document.createElement("video");
  media.playsInline = true;
  media.preload = "metadata";
  media.style.display = "none";
  document.body.appendChild(media);

  // Helper to format time
  function fmtTime(sec) {
    if (!isFinite(sec) || sec < 0) return "0:00";
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60)
      .toString()
      .padStart(2, "0");
    return `${m}:${s}`;
  }

  // Fetch all files with webContentLink included
  async function fetchAllFromFolder() {
    let out = [];
    let pageToken = "";
    folderStatus.textContent = "Folder: fetching…";

    const baseUrl = "https://www.googleapis.com/drive/v3/files";
    const fields = encodeURIComponent(
      "nextPageToken, files(id, name, mimeType, size, modifiedTime, webContentLink, thumbnailLink, videoMediaMetadata)"
    );
    const query = encodeURIComponent(
      `'${FOLDER_ID}' in parents and trashed=false and (mimeType contains 'video' or mimeType contains 'audio')`
    );

    while (true) {
      const url = `${baseUrl}?q=${query}&fields=${fields}&pageSize=100&key=${API_KEY}${
        pageToken ? `&pageToken=${pageToken}` : ""
      }`;

      const res = await fetch(url);
      const data = await res.json();

      if (data.error) {
        listEl.innerHTML = `<div class="empty">Drive API error: ${data.error.message}. Make sure files are shared publicly.</div>`;
        throw new Error(data.error.message);
      }

      if (Array.isArray(data.files)) {
        out.push(...data.files);
        statLoaded.textContent = out.length;
      }

      if (!data.nextPageToken) break;
      pageToken = data.nextPageToken;
    }
    folderStatus.textContent = "Folder: loaded";
    return out;
  }

  // Map files to track objects, only keep files with webContentLink (public)
  function mapTracks(files) {
    return files
      .filter((f) => f.webContentLink) // skip if no public download link
      .map((f, i) => ({
        id: f.id,
        name: f.name,
        mime: f.mimeType,
        size: +(f.size || 0),
        mtime: f.modifiedTime,
        webContentLink: f.webContentLink.replace(/&export=download$/, ""),
        thumb: f.thumbnailLink || "",
        index: i,
      }));
  }

  // Render track list
  function renderList(items) {
    listEl.innerHTML = "";
    if (!items.length) {
      listEl.innerHTML =
        '<div class="empty">No public video/audio files found in this folder.</div>';
      return;
    }

    items.forEach((t, i) => {
      const row = document.createElement("div");
      row.className = "row";
      row.dataset.index = i;

      const head = document.createElement("div");
      head.className = "row-head";
      head.innerHTML = `
        <div class="idx">${i + 1}</div>
        <div class="name">${t.name}</div>
        <div class="meta">${(t.size / 1_000_000).toFixed(1)} MB</div>
        <div class="meta">${new Date(t.mtime).toLocaleDateString()}</div>
        <div class="expand">▾</div>`;

      const body = document.createElement("div");
      body.className = "row-body";
      body.innerHTML = `
        <div class="player-inline">
          <div>
            <div class="thumb" style="background-image:url('${t.thumb}')"></div>
          </div>
          <div>
            <video controls playsinline preload="metadata"></video>
          </div>
        </div>`;

      head.addEventListener("click", () => {
        const open = row.classList.toggle("open");
        if (open) {
          // Close others
          document.querySelectorAll(".row.open").forEach((el) => {
            if (el !== row) el.classList.remove("open");
          });
          const v = body.querySelector("video");
          if (!v.src) v.src = t.webContentLink;
          updateNowBar(t, v);
          wireInlineVideo(v, i);
        }
      });

      row.appendChild(head);
      row.appendChild(body);
      listEl.appendChild(row);
    });
  }

  // Now Playing bar elements & controls (same as before, simplified here)
  const npTitle = document.getElementById("npTitle");
  const npSubtitle = document.getElementById("npSubtitle");
  const npCover = document.getElementById("npCover");
  const btnPrev = document.getElementById("prevBtn");
  const btnPlayPause = document.getElementById("playPauseBtn");
  const btnNext = document.getElementById("nextBtn");
  const rngSeek = document.getElementById("seek");
  const rngVol = document.getElementById("vol");
  const curTime = document.getElementById("curTime");
  const dur = document.getElementById("dur");

  function updateNowBar(track, inlineVideo) {
    npTitle.textContent = track?.name || "Nothing playing";
    npSubtitle.textContent = track ? "Ready" : "Select a track to start";
    npCover.style.backgroundImage = track?.thumb
      ? `url('${track.thumb}')`
      : "";
    if (inlineVideo && inlineVideo.src) {
      media.src = inlineVideo.src;
      media.currentTime = inlineVideo.currentTime || 0;
      rngSeek.value = 0;
      curTime.textContent = "0:00";
      dur.textContent = "0:00";
    }
    currentIndex = filtered.indexOf(track);
  }

  function syncInlineWithMedia() {
    const open = document.querySelector(".row.open video");
    if (!open) return;
    if (Math.abs(open.currentTime - media.currentTime) > 0.35) {
      open.currentTime = media.currentTime;
    }
    if (open.paused !== media.paused) {
      if (media.paused) open.pause();
      else open.play().catch(() => {});
    }
  }

  function wireInlineVideo(v, index) {
    v.addEventListener("play", () => {
      if (media.src !== v.src) media.src = v.src;
      media.play().catch(() => {});
      btnPlayPause.textContent = "⏸";
      npSubtitle.textContent = "Playing";
    });
    v.addEventListener("pause", () => {
      media.pause();
      btnPlayPause.textContent = "▶";
      npSubtitle.textContent = "Paused";
    });
    v.addEventListener("timeupdate", () => {
      media.currentTime = v.currentTime;
    });
  }

  btnPlayPause.addEventListener("click", async () => {
    if (!media.src) {
      if (!filtered.length) return;
      const firstRow = document.querySelector(".row");
      firstRow?.querySelector(".row-head")?.click();
      return;
    }
    if (media.paused) {
      await media.play().catch(() => {});
      btnPlayPause.textContent = "⏸";
      npSubtitle.textContent = "Playing";
    } else {
      media.pause();
      btnPlayPause.textContent = "▶";
      npSubtitle.textContent = "Paused";
    }
  });

  btnPrev.addEventListener("click", () => {
    if (currentIndex <= 0) return;
    const prevRow = document.querySelector(`.row[data-index="${currentIndex - 1}"]`);
    prevRow?.querySelector(".row-head")?.click();
  });

  btnNext.addEventListener("click", () => {
    if (currentIndex >= filtered.length - 1) return;
    const nextRow = document.querySelector(`.row[data-index="${currentIndex + 1}"]`);
    nextRow?.querySelector(".row-head")?.click();
  });

  rngSeek.addEventListener("input", () => {
    media.currentTime = parseFloat(rngSeek.value);
    syncInlineWithMedia();
  });

  rngVol.addEventListener("input", () => {
    media.volume = parseFloat(rngVol.value);
  });

  media.addEventListener("timeupdate", () => {
    if (!media.duration) return;
    curTime.textContent = fmtTime(media.currentTime);
    dur.textContent = fmtTime(media.duration);
    rngSeek.max = media.duration;
    rngSeek.value = media.currentTime;
    syncInlineWithMedia();
  });

  media.addEventListener("ended", () => {
    btnPlayPause.textContent = "▶";
    npSubtitle.textContent = "Ended";
    btnNext.click();
  });

  document.getElementById("search").addEventListener("input", (e) => {
    const q = e.target.value.toLowerCase();
    filtered = tracks.filter((t) => t.name.toLowerCase().includes(q));
    renderList(filtered);
    statItems.textContent = filtered.length;
  });

  document.getElementById("refreshBtn").addEventListener("click", async () => {
    listEl.innerHTML = '<div class="empty">Refreshing files…</div>';
    try {
      const files = await fetchAllFromFolder();
      tracks = mapTracks(files);
      filtered = [...tracks];
      statItems.textContent = tracks.length;
      statLoaded.textContent = tracks.length;
      fileCount.textContent = `Loaded ${tracks.length} videos`;
      renderList(filtered);
    } catch (e) {
      listEl.innerHTML = `<div class="empty">Error loading files: ${e.message}</div>`;
    }
  });

  let tracks = [];

  (async () => {
    try {
      const files = await fetchAllFromFolder();
      tracks = mapTracks(files);
      filtered = [...tracks];
      statItems.textContent = tracks.length;
      statLoaded.textContent = tracks.length;
      fileCount.textContent = `Loaded ${tracks.length} videos`;
      renderList(filtered);
      folderStatus.textContent = "Folder: loaded";
    } catch (e) {
      listEl.innerHTML = `<div class="empty">Error loading files: ${e.message}</div>`;
      folderStatus.textContent = "Folder: error";
    }
  })();
</script>
</body>
</html>
